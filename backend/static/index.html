<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¸ì—¬ìœ¨ ê´€ë¦¬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #totalParticipation {
            font-size: 16px;
            font-weight: bold;
        }
        .overLimit {
            color: red;
            font-weight: bold;
        }
        .container {
            display: flex;
            justify-content: space-between;
        }
        .panel {
            width: 48%;
            padding: 10px;
            box-sizing: border-box;
        }
        .panel-left {
            border-right: 1px solid #000;
        }
        .section {
            margin-bottom: 15px;
        }
        .sub-container {
            display: flex;  
            justify-content: space-between;
        }
        .sub-panel {
            width: 48%;
            padding: 5px;
            box-sizing: border-box;
        }
        .selected {
            background-color: #eef;
        }
        ul {
            list-style: none;
            padding: 0;
        }
        li {
            cursor: pointer;
            padding: 5px;
            border-bottom: 1px solid #ddd;
        }
        li:hover {
            background-color: #f1f1f1;
        }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
document.getElementById("downloadExcelBtn").addEventListener("click", async () => {
    const department = document.getElementById("departmentSelect").value;
    if (!department) {
        alert("ë¶€ì„œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
        return;
    }

    const staffListRes = await fetch(`${BASE_URL}/staff?department=${department}`);
    const staffList = await staffListRes.json();
    const token = localStorage.getItem("token");

    let allData = [];

    for (const staff of staffList) {
        const res = await fetch(`/participation?staffId=${staff.staffId}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const participation = await res.json();
        participation.forEach(entry => {
            allData.push({
                ë¶€ì„œëª…: department,
                ì´ë¦„: staff.userName,
                ì‚¬ì—…ëª…: entry.projectName ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ì—…",
                ì°¸ì—¬ìœ¨: entry.participationRate,
                ê³¼ì œì±…ì„: entry.leadTaskFlag ? "Y" : ""
            });
        });
    }

    if (allData.length === 0) {
        alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(allData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì°¸ì—¬ìœ¨");

    XLSX.writeFile(wb, "ì°¸ì—¬ìœ¨_ë‹¤ìš´ë¡œë“œ.xlsx");
});

</script>
</head>
<body>
    <h1 style="display: inline-block;">ì°¸ì—¬ìœ¨ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
<button id="downloadExcelBtn" style="float: right; margin-top: 10px;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>

    <div class="container">
        <!-- ì™¼ìª½: ì¸ì› ê´€ë¦¬ -->
        <div class="panel panel-left">
            <h2>ì¸ì› ê´€ë¦¬</h2>
            <div class="section">
                <label for="departmentSelect">ë¶€ì„œ ì„ íƒ:</label>
                <select id="departmentSelect" onchange="loadStaff()">
                    <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            
            <div class="sub-container"> 
                <!-- ì§ì› ëª©ë¡ -->
                <div class="sub-panel">
                    <h3>ì§ì› ëª©ë¡</h3>
                    <ul id="staffList"></ul>
                </div>

                <!-- ì°¸ì—¬ ì •ë³´ -->
                <div class="sub-panel">
                    <h3>ì°¸ì—¬ ì •ë³´</h3>
                    <p id="totalParticipation">ì´ ì°¸ì—¬ìœ¨: 0%</p>
                    <div id="projectInputs"></div>
                    <button onclick="addProjectInput()">ì‚¬ì—… ì¶”ê°€</button>
                    <button onclick="saveAllParticipation()">ì €ì¥</button>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì‚¬ì—… ê´€ë¦¬ -->
        <div class="panel">
            <h2>ì‚¬ì—… ê´€ë¦¬</h2>
            <div class="section">
                <label for="projectDepartmentSelect">ë¶€ì„œ ì„ íƒ:</label>
                <select id="projectDepartmentSelect" onchange="loadProjects()">
                    <option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="section">
                <h3>ì‚¬ì—… ëª©ë¡</h3>
                <ul id="projectList"></ul>
            </div>
        </div>
    </div>

    <script>
    const token = localStorage.getItem("token");
    if (!token) {
        window.location.href = "/static/login.html";
    }
        const BASE_URL = window.location.origin;
        let projectCount = 0;
        let selectedStaffId = null;
        let userRole = null;

        window.onload = function () {
            loadDepartments();
        };
// í† í° ë””ì½”ë”© (payload íŒŒì‹±)
    function parseJwt(token) {
        try {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        } catch (e) {
            console.error("í† í° íŒŒì‹± ì‹¤íŒ¨", e);
            return null;
        }
    }

// í˜ì´ì§€ ë¡œë”© ì‹œ ì‚¬ìš©ì role í™•ì¸
    window.onload = function () {
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "/static/login.html";
        } else {
            const decoded = parseJwt(token);
            if (decoded && decoded.role) {
                userRole = decoded.role;
                console.log("í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì role:", userRole);
            }
        }
        loadDepartments();
    };

    function loadDepartments() {
        fetch(`${BASE_URL}/departments/staff`)
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("departmentSelect");
                select.innerHTML = `<option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>`;

                // âœ… ë§ˆìŠ¤í„° ê³„ì •(admin)ì¼ ê²½ìš° "ì „ ë¶€ì„œ" ì˜µì…˜ ì¶”ê°€
                if (userRole === 'admin') {
                    const allOpt = document.createElement("option");
                    allOpt.value = "ALL";
                    allOpt.textContent = "- ì „ ë¶€ì„œ -";
                    select.appendChild(allOpt);
                }

                data.forEach(dept => {
                    const opt = document.createElement("option");
                    opt.value = dept;
                    opt.textContent = dept;
                    select.appendChild(opt);
                });
            });

        fetch(`${BASE_URL}/departments/projects`)
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById("projectDepartmentSelect");
                select.innerHTML = `<option value="">ë¶€ì„œë¥¼ ì„ íƒí•˜ì„¸ìš”</option>`;
                data.forEach(dept => {
                    const opt = document.createElement("option");
                    opt.value = dept;
                    opt.textContent = dept;
                    select.appendChild(opt);
                });
            });
    }

        function updateStaffParticipationDisplay(staffId) {
            const staffListItems = document.querySelectorAll("#staffList li");

            staffListItems.forEach(li => {
                if (li.dataset.staffId === staffId) {
                    let existingParticipation = li.querySelector(".staffParticipation");
                    if (existingParticipation) existingParticipation.remove();

                    fetch(`${BASE_URL}/participation?staffId=${staffId}`)
                        .then(response => response.json())
                        .then(data => {
                            let totalParticipation = data.reduce((sum, entry) => sum + parseFloat(entry.participationRate), 0);
                            let colorClass = totalParticipation > 129 ? "red" : totalParticipation > 100 ? "orange" : "black";

                            let span = document.createElement("span");
                            span.classList.add("staffParticipation");
                            span.style.color = colorClass;
                            span.style.fontWeight = "bold";
                            span.style.marginLeft = "10px";
                            span.textContent = `ì´ ${totalParticipation}%`;

                            li.appendChild(span);
                        })
                        .catch(error => console.error("ì´ ì°¸ì—¬ìœ¨ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:", error));
                }
            });
        }

        function saveAllParticipation() {
            if (!selectedStaffId) {
                alert("ì§ì›ì„ ì„ íƒí•˜ì„¸ìš”!");
                return;
            }

            let participationData = [];
            document.querySelectorAll("#projectInputs div").forEach(div => {
                const projectId = div.querySelector(".selectedProject").dataset.projectId;
                const participationRate = parseFloat(div.querySelector(".participationRate").value) || 0;
                const leadTaskFlag = div.querySelector(".leadTaskFlag").checked;

                if (!projectId) {
                    alert("ì‚¬ì—…ì„ ì„ íƒí•˜ì„¸ìš”!");
                    return;
                }

                participationData.push({
                    staffId: selectedStaffId,
                    projectId: projectId,
                    participationRate: participationRate,
                    leadTaskFlag: leadTaskFlag
                });
            });

            if (participationData.length === 0) {
                alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!");
                return;
            }

            document.querySelectorAll(".staffParticipation").forEach(span => span.remove());

            fetch(`${BASE_URL}/participation`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(participationData)
            })
            .then(response => response.json())
            .then(data => {
                console.log("ğŸš€ ì°¸ì—¬ìœ¨ ì €ì¥ ì™„ë£Œ:", data);
                let currentSelected = selectedStaffId;
                loadStaff();
                setTimeout(() => {
                    let staffItem = document.querySelector(`[data-staff-id="${currentSelected}"]`);
                    if (staffItem) staffItem.classList.add("selected");
                }, 300);
                updateStaffParticipationDisplay(selectedStaffId);
                setTimeout(() => {
                    alert(data.message);
                }, 200);
            })
            .catch(error => {
                console.error("ì°¸ì—¬ìœ¨ ì €ì¥ ì‹¤íŒ¨:", error);
                alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            });
        }

        function loadStaff() {
    const department = document.getElementById("departmentSelect").value;
    if (!department) return;

    fetch(`${BASE_URL}/staff?department=${department}`)
        .then(response => response.json())
        .then(data => {
            const staffList = document.getElementById("staffList");
            staffList.innerHTML = "";

            // ë¶€ì„œë³„ë¡œ ê·¸ë£¹í•‘
            const groupedByDepartment = {};

            data.forEach(staff => {
                const dept = staff.staffDepartment || "ê¸°íƒ€";
                if (!groupedByDepartment[dept]) {
                    groupedByDepartment[dept] = [];
                }
                groupedByDepartment[dept].push(staff);
            });

            // ë¶€ì„œë³„ë¡œ ì¶œë ¥
            Object.keys(groupedByDepartment).sort().forEach(dept => {
                // ë¶€ì„œëª… í‘œì‹œ
                const deptHeader = document.createElement("h3");
                deptHeader.textContent = `ğŸ“ ${dept}`;
                deptHeader.style.marginTop = "20px";
                staffList.appendChild(deptHeader);

                const staffArray = groupedByDepartment[dept];

                // ë³´ì§ì/ì¼ë°˜ì§ì› ë‚˜ëˆ„ê¸°
                const executives = []; // ë‹¨ì¥/ë³¸ë¶€ì¥
                const managers = [];   // ì„¼í„°ì¥/ì‹¤ì¥
                const normals = [];    // ì¼ë°˜ì§ì›

                staffArray.forEach(staff => {
                    const position = (staff.staffClass || "").trim();
                    if (position === "ë‹¨ì¥" || position === "ë³¸ë¶€ì¥") {
                        executives.push(staff);
                    } else if (position === "ì„¼í„°ì¥" || position === "ì‹¤ì¥") {
                        managers.push(staff);
                    } else {
                        normals.push(staff);
                    }
                });

                const sortedStaffs = [...executives, ...managers, ...normals]; // ìˆœì„œëŒ€ë¡œ í•©ì¹˜ê¸°

                // ì§ì› ì¶œë ¥
                sortedStaffs.forEach(staff => {
                    let li = document.createElement("li");
                    let background = "";
                    const position = (staff.staffClass || "").trim();

                    // âœ… ë°°ê²½ìƒ‰ ì¡°ê±´
                    if (position === "ë‹¨ì¥" || position === "ë³¸ë¶€ì¥") {
                        background = "rgba(173, 255, 47, 0.2)"; // ì—°í•œ ì—°ë‘
                    } else if (position === "ì„¼í„°ì¥" || position === "ì‹¤ì¥") {
                        background = "rgba(255, 255, 102, 0.2)"; // ì—°í•œ ë…¸ë‘
                    }

                    const total = staff.totalParticipation ?? 0;
                    const leadCount = staff.leadTaskCount ?? 0;

                    const totalColor = total > 129 ? "red" : total > 100 ? "orange" : "black";
                    const leadColor = leadCount >= 4 ? "red" : leadCount >= 3 ? "orange" : "black";

                    li.innerHTML = `<span>${staff.userName} (${staff.staffId})</span>
                        <span style="float: right;">
                            <span style="color: ${totalColor}; font-weight: bold;">ì´ ${total}%</span> /
                            <span style="color: ${leadColor}; font-weight: bold;">ì±…ì„: ${leadCount}ê°œ</span>
                        </span>`;
                    li.style.backgroundColor = background;
                    li.setAttribute("style", `background-color: ${background} !important`);

                    li.dataset.staffId = staff.staffId;
                    li.onclick = function () {
                        selectedStaffId = staff.staffId;
                        document.querySelectorAll("#staffList li").forEach(item => item.classList.remove("selected"));
                        this.classList.add("selected");
                        loadExistingParticipation(staff.staffId);
                    };

                    staffList.appendChild(li);
                });
            });
        })
        .catch(error => console.error("ì§ì› ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
}

        function loadExistingParticipation(staffId) {
            fetch(`${BASE_URL}/participation?staffId=${staffId}`)
                .then(response => response.json())
                .then(data => {
                    projectCount = 0;
                    document.getElementById("projectInputs").innerHTML = "";
                    data.forEach(entry => addProjectInput(entry));
                })
                .catch(error => console.error("ê¸°ì¡´ ì°¸ì—¬ìœ¨ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
        }

        function loadProjects() {
            const department = document.getElementById("projectDepartmentSelect").value;
            if (!department) return;

            fetch(`${BASE_URL}/projects?department=${department}`)
                .then(response => response.json())
                .then(data => {
                    const projectList = document.getElementById("projectList");
                    projectList.innerHTML = "";
                    data.forEach(project => {
                        let li = document.createElement("li");
                        li.textContent = project.projectName;
                        li.onclick = () => selectProject(project.projectId, project.projectName);
                        projectList.appendChild(li);
                    });
                })
                .catch(error => console.error("ì‚¬ì—… ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error));
        }

        function selectProject(id, name) {
            const allInputs = document.querySelectorAll(".selectedProject");
            for (let input of allInputs) {
                if (input.dataset.projectId === id) {
                    alert("ì´ë¯¸ ì„ íƒëœ ì‚¬ì—…ì…ë‹ˆë‹¤.");
                    return;
                }
            }

            for (let input of allInputs) {
                if (!input.value) {
                    input.value = name;
                    input.dataset.projectId = id;
                    input.dataset.projectName = name;
                    return;
                }
            }

            alert("ì‚¬ì—… ì¶”ê°€ ë²„íŠ¼ì„ ë¨¼ì € ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        }

        function addProjectInput(entry = null) {
            if (projectCount >= 5) {
                alert("ìµœëŒ€ 5ê°œì˜ ì‚¬ì—…ë§Œ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!");
                return;
            }

            projectCount++;
            const projectInputs = document.getElementById("projectInputs");
            const div = document.createElement("div");

            div.innerHTML = `
                <span>ìˆœë²ˆ ${projectCount}:</span>
                <input type="text" class="selectedProject" readonly placeholder="ì˜¤ë¥¸ìª½ì—ì„œ ì‚¬ì—… ì„ íƒ">
                <input type="number" class="participationRate" placeholder="ì°¸ì—¬ìœ¨ ì…ë ¥ (%)" oninput="updateTotalParticipation()">
                <label><input type="checkbox" class="leadTaskFlag"> ê³¼ì œ ì±…ì„</label>
                <button onclick="removeProjectInput(this)">ì‚­ì œ</button>
            `;

            projectInputs.appendChild(div);

            if (entry) {
                const projectInput = div.querySelector(".selectedProject");
                const rateInput = div.querySelector(".participationRate");
                const leadFlag = div.querySelector(".leadTaskFlag");

                projectInput.value = entry.projectName ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ì—…";
                projectInput.dataset.projectId = entry.projectId;
                projectInput.dataset.projectName = entry.projectName;
                rateInput.value = entry.participationRate;
                leadFlag.checked = entry.leadTaskFlag === 1;
            }

            updateTotalParticipation();
        }

        function removeProjectInput(button) {
            button.parentElement.remove();
            projectCount--;
            updateTotalParticipation();
        }

        function updateTotalParticipation(total = null) {
            if (total === null) {
                total = 0;
                document.querySelectorAll(".participationRate").forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
            }
            document.getElementById("totalParticipation").textContent = `ì´ ì°¸ì—¬ìœ¨: ${total}%`;
        }
async function fetchParticipationData() {
    const token = localStorage.getItem("token");
    const staffId = selectedStaffId; // ğŸ”¥ ì´ ì¤„ ì¶”ê°€

    if (!staffId) return;            // ğŸ” ì´ ì¤„ë„ ê¼­ ì¶”ê°€

    const response = await fetch(`/participation?staffId=${staffId}`, {
        method: "GET",
        headers: {
            "Authorization": `Bearer ${token}`
        }
    });

    if (response.ok) {
        const data = await response.json();
        console.log("ì°¸ì—¬ìœ¨ ë°ì´í„°:", data);
        // ì—¬ê¸°ì„œ ë°ì´í„°ë¥¼ ë°›ì•„ UIì— ë¿Œë ¤ì£¼ë©´ ë©ë‹ˆë‹¤
    } else if (response.status === 401) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
        window.location.href = "/static/login.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
    } else {
        alert("ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    }
}
window.addEventListener("beforeunload", () => {
    localStorage.removeItem("token");
});
// í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° í˜¸ì¶œ ì˜ˆì‹œ
//window.onload = fetchParticipationData;    
    
document.getElementById("downloadExcelBtn").addEventListener("click", async () => {
    const department = document.getElementById("departmentSelect").value;
    if (!department) {
        alert("ë¶€ì„œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”!");
        return;
    }

    const staffListRes = await fetch(`${BASE_URL}/staff?department=${department}`);
    const staffList = await staffListRes.json();
    const token = localStorage.getItem("token");

    let allData = [];

    for (const staff of staffList) {
        const res = await fetch(`/participation?staffId=${staff.staffId}`, {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const participation = await res.json();
        participation.forEach(entry => {
            allData.push({
                ë¶€ì„œëª…: department,
                ì´ë¦„: staff.userName,
                ì‚¬ì—…ëª…: entry.projectName ?? "ì•Œ ìˆ˜ ì—†ëŠ” ì‚¬ì—…",
                ì°¸ì—¬ìœ¨: entry.participationRate,
                ê³¼ì œì±…ì„: entry.leadTaskFlag ? "Y" : ""
            });
        });
    }

    if (allData.length === 0) {
        alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(allData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ì°¸ì—¬ìœ¨");

    XLSX.writeFile(wb, "ì°¸ì—¬ìœ¨_ë‹¤ìš´ë¡œë“œ.xlsx");
});

</script>
</body>
</html>